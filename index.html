<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Roguelike Game</title>
  <style>
    body {
      font-family: sans-serif;
      background: #1a1a1a;
      color: #f0f0f0;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    .log {
      background: #2a2a2a;
      padding: 1rem;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .choice {
      display: block;
      background: #444;
      margin: 0.5rem 0;
      padding: 0.5rem;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    .choice:hover {
      background: #666;
    }
  </style>
</head>
<body>
  <h1>AI Dungeon (Gemini)</h1>
  <div>
    <label for="class-select">Choose your class:</label>
    <select id="class-select">
      <option value="warrior">Warrior</option>
      <option value="mage">Mage</option>
      <option value="rogue">Rogue</option>
    </select>
    <button onclick="startGame()">Start</button>
  </div>
  <div class="log" id="log"></div>
  <div id="choices"></div>
  <script>
    const log = document.getElementById('log');
    const choicesDiv = document.getElementById('choices');
    let playerClass = '';
    let gameContext = '';
    let score = 0;

    const apiKey = 'AIzaSyBR9SufVmHRT9ODxoMSloZRZ5Rd77fjqQU';

    async function askAI(prompt) {
      const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + apiKey, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });
      const data = await response.json();
      try {
        return data.candidates[0].content.parts.map(p => p.text).join('');
      } catch {
        return "Something went wrong. Try again.";
      }
    }

    function addToLog(text) {
      log.innerHTML += `<p>${text.replace(/\n/g, '<br>')}</p>`;
      log.scrollTop = log.scrollHeight;
    }

    async function startGame() {
      playerClass = document.getElementById('class-select').value;
      gameContext = `You are a brave ${playerClass} entering a dangerous world. Begin your adventure.`;
      score = 0;
      log.innerHTML = '';
      addToLog(`<strong>Class:</strong> ${playerClass}`);
      nextStep();
    }

    async function nextStep(choice = '') {
      if (choice) {
        gameContext += `\nPlayer chose: ${choice}`;
      }
      const prompt = `${gameContext}\nDescribe the next RPG-style encounter. Present 3 numbered choices. End the response with 'GAME OVER' if the player dies.`;
      const reply = await askAI(prompt);
      gameContext += `\n${reply}`;
      addToLog(reply.split(/\d+\. /)[0]);

      const choiceLines = reply.match(/\d+\. .+/g) || [];
      choicesDiv.innerHTML = '';
      choiceLines.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = c;
        btn.onclick = () => handleChoice(c);
        choicesDiv.appendChild(btn);
      });

      score++;
      if (reply.includes("GAME OVER")) {
        addToLog(`<strong>Final Score:</strong> ${score}`);
        updateLeaderboard(score);
        choicesDiv.innerHTML = '';
      }
    }

    function handleChoice(choice) {
      addToLog(`<em>${choice}</em>`);
      nextStep(choice);
    }

    function updateLeaderboard(score) {
      const scores = JSON.parse(localStorage.getItem('scores') || '[]');
      scores.push(score);
      scores.sort((a,b) => b - a);
      localStorage.setItem('scores', JSON.stringify(scores.slice(0, 5)));
      addToLog('<hr><strong>Top Scores:</strong><br>' + scores.slice(0,5).join('<br>'));
    }
  </script>
</body>
</html>
